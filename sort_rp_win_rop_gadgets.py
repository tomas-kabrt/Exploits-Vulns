"""
This script clears the output of the rp_win as it can be rather long and hard to work with. The script
groups the ROP gadgets based on the gadget and shows a maximum of 10 addresses for better readability.
It also removes gadgets with call/jmp to a dword as it is hardly usable in exploitation scenarios.

Author: Tomas Kabrt
"""

import re

#Path to the output from rp-win - for example rp-win-x86.exe -f SNFS.dll -r 5 > SNFS.txt
with open('/Users/admin/Desktop/SNFS.txt', 'r', encoding='UTF-16 LE') as f:
    lines = f.readlines()[10:]  # skip the first 10 lines

line_dict = {}

for line in lines:
    #Do not save gadgets which ends with call/jump to address - it has no usage in ROP buidling
    if not re.findall(r'(call|jmp) dword \[[^\[]*] ;', line[:-12]):
        key = line[12:-12]
        value = line[:10].strip()
        if key in line_dict:
            if len(line_dict[key]) < 10:
                line_dict[key].append(value)
        else:
            line_dict[key] = [value]

print(len(line_dict))

with open("/Users/admin/SNFS_sorted.txt", "w") as f:
    for key, values in line_dict.items():
        f.write(key + " ||| " + " ".join(values) + "\n")
